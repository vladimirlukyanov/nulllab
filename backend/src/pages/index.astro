---
import path from 'node:path';
import {Image, Picture} from "astro:assets";

import {getCollection} from "astro:content";

import FormattedDate from "../components/FormattedDate.astro";

import LayoutIndex from "../layouts/index.astro";

const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.published_date.valueOf() - a.data.published_date.valueOf(),
);

const arts = posts.filter((post) => {
    return post.data.category === 'images';
});

const quotes = posts.filter((post) => {
    return post.data.category === "quote";
});

const featured_post = posts.filter((post) => post.data.featured).at(0);

function getFirstXWords(input, x, options = {}) {
    // Default options
    const {
        appendEllipsis = false,  // Add "..." if string was truncated
        preservePunctuation = true,  // Keep punctuation attached to words
        strictWordCount = false  // Count hyphenated words as one word
    } = options;

    // Validation
    if (!input || typeof input !== 'string' || x <= 0) return '';

    // Split into words with different strategies
    let words;
    if (preservePunctuation) {
        words = input.trim().match(/(\S+)\s*/g) || [];
    } else {
        words = input.trim().split(/\s+/) || [];
    }

    // Handle hyphenated words if strictWordCount is true
    if (strictWordCount) {
        words = words.slice(0, x);
    } else {
        // Count each hyphenated part as separate words
        let count = 0;
        words = words.filter(word => {
            if (count >= x) return false;
            const subWords = word.split(/[-\/]/);
            count += subWords.length;
            return true;
        });
    }

    // Join the words
    let result = words.join(' ').trim();

    // Add ellipsis if needed
    if (appendEllipsis && input.trim().split(/\s+/).length > x) {
        result += '...';
    }

    return result;
}
---

<LayoutIndex>
    <section class="hot">
        <div class="container xxl">
            <div>Hot</div>
            <div class="grid">
                <div class="one">
                    {
                        posts.slice(0, 2).map((post, index) => {
                            if (index === 0) {
                                return (
                                        <div class="post">
                                            <div class="right">
                                                <a href={`/${post.id.substring(5)}/`} class="link">
                                                    <Image
                                                            class="image"
                                                            width={370}
                                                            aspectRatio={1.3333333333333333}
                                                            src={post.data.image.url}
                                                            alt={post.data.image.alt}
                                                    />
                                                    <span class="title">{post.data.title}</span>
                                                    <p class="date">
                                                        <FormattedDate date={post.data.published_date}/>
                                                    </p>
                                                </a>
                                            </div>
                                        </div>
                                );
                            } else {
                                return (
                                        <div class="post">
                                            <div class="right">
                                                <a href={`/${post.id.substring(5)}/`} class="link">
                                                    <span class="title">{post.data.title}</span>
                                                    <span class="description">
                                                        {getFirstXWords(post.data.description, 30, {
                                                            appendEllipsis: true
                                                        })}
                                                    </span>
                                                    <p class="date">
                                                        <FormattedDate date={post.data.published_date}/>
                                                    </p>
                                                </a>
                                            </div>
                                        </div>
                                );
                            }
                        })
                    }
                </div>
                <div class="two">
                    <div class="featured">
                        <a href={`/${featured_post.id.substring(5)}/`} class="link">
                            <span class="image">
                                <Image src={featured_post.data.image.url} alt={'11'} class="image"/>
                            </span>
                            <span class="bottom">
                                <span class="text">
                                    <span class="category">{featured_post.data.category}</span>
                                    <span class="title">{featured_post.data.title}</span>
                                    <span class="date">
                                        <FormattedDate date={featured_post.data.published_date}/>
                                    </span>
                                </span>
                            </span>
                        </a>
                    </div>
                </div>
                <div class="three">
                    {
                        posts.slice(2, 6).map((post) => {
                            return (
                                    <div class="post">
                                        <div class="left">
                                            <Image
                                                    width={130}
                                                    aspectRatio={1.3333333333333333}
                                                    src={post.data.image.url}
                                                    alt={post.data.image.alt}
                                            />
                                        </div>
                                        <div class="right">
                                            <a href={`/${post.id.substring(5)}/`} class="link">
                                                <span class="title">{post.data.title}</span>
                                                <p class="date">
                                                    <FormattedDate date={post.data.published_date}/>
                                                </p>
                                            </a>
                                        </div>
                                    </div>
                            );
                        })
                    }
                </div>
            </div>
        </div>
    </section>

    <section class="art">
        <div class="container xxl">
            <div>Images</div>
            <div class="grid">
                {
                    arts.map((post) => {
                        if (post.data?.image) {
                            return (
                                    <div>
                                        <a href={`/${post.id.substring(5)}/`} class="link">
                                            <Image
                                                    width={330}
                                                    height={250}
                                                    aspectRatio={1.3333333333333333}
                                                    src={post.data.image.url}
                                                    alt={post.data.image.alt}
                                            />
                                        </a>
                                    </div>
                            );
                        }
                    })
                }
            </div>
        </div>
    </section>

    <section class="quotes">
        <div class="container xxl">
            <div>Quotes</div>
            <div class="grid">
                {
                    quotes.map((post) => {
                        if (post.data?.description) {
                            return (
                                    <div>
                                        <a href={`/${post.id.substring(5)}/`} class="link">
                                            123
                                        </a>
                                    </div>
                            );
                        }
                    })
                }
            </div>
        </div>
    </section>
</LayoutIndex>

<style lang="scss">
  @use "sass:list";
  @use "sass:string";
  @use "sass:meta";
  @use "sass:map";

  @use "../styles/app.scss" as app;

  @use "../styles/scss/mixins.scss" as mixins;
  @use "../styles/scss/functions.scss" as functions;

  // --- hot section --- //

  $hot-section: (
      margin: 25px 0,
      _subclasses: (
          '.grid': (
              display: grid,
              width: 100%,
              grid-template-columns: 1fr,
              grid-auto-rows: auto,
              grid-gap: 0,

              _responsive: (
                  md : (
                      grid-template-columns: 1fr 1fr,
                  ),
                  lg: (
                      grid-template-columns: 1fr fit-content(51%) 1fr,
                      grid-gap: 1rem,
                  ),
              ),

              _subclasses: (
                  '.one' : (
                      _subclasses: (
                          '.post' : (
                              display: block,
                              width: 100%,
                            /*grid-template-columns: 1fr,*/
                            /*grid-auto-rows: auto,*/
                            /*grid-gap: 0,*/
                              margin: 0 0 10px 0,
                              _responsive: (
                                  md: (
                                    /*grid-template-columns: auto 1fr,*/
                                    /*grid-gap: 1rem,*/
                                  ),
                              ),
                              _subclasses: (
                                  '.image' : (
                                      display: block,
                                      margin: 0 0 10px 0,
                                  ),
                                  '.title': (
                                      font-size: 1.25rem,
                                      display: block,
                                      margin: 0 0 10px 0,
                                      font-weight: 500,
                                  ),
                                  '.description': (
                                      display: block,
                                      margin: 0 0 10px 0,
                                  ),
                                  '.date' : (
                                      font-size: 0.825rem,
                                      color: #959595,
                                  )
                              )
                          )
                      )
                  ),
                  '.two' : (
                      _subclasses: (
                          '.featured' : (
                              _subclasses: (
                                  '.link' : (
                                      display: block,
                                      _subclasses: (
                                          '.image' : (
                                              position: relative,
                                              display: block,
                                              _subclasses: (
                                                  '.shadow' : (
                                                      position: absolute,
                                                      display: block,
                                                      left: 0,
                                                      top: 0,
                                                      width: 100%,
                                                      height: 100%,
                                                      background-image: string.unquote('linear-gradient(-180deg, rgba(0, 0, 0, 0.01) 0%, rgba(0, 0, 0, 0.62) 62%, rgba(0, 0, 0, 0.82) 82%, rgba(0, 0, 0, 0.86) 86%)'),
                                                  ),
                                              )
                                          ),
                                          '.text' : (
                                            /*position: absolute,*/
                                            /*bottom: 15px,*/
                                            /*left: 15px,*/
                                              width: 100%,
                                              display: flex,
                                              flex-direction: column,
                                              gap: 10px,
                                              _subclasses: (
                                                  '.category' : (
                                                      font-size: 0.825rem,
                                                      color: #8c602e,
                                                      font-weight: bold,
                                                      text-transform: capitalize,
                                                  ),
                                                  '.title' : (
                                                      font-size: 1.5rem,
                                                  ),
                                                  '.date' : (
                                                      font-size: 0.825rem,
                                                      color: #959595,
                                                  )
                                              )
                                          ),
                                      ),
                                  ),
                              ),
                          ),
                      ),
                      '.hot_image' : (
                          display: block,
                          height: 400px,
                      ),
                      '.link': (
                          text-decoration: none,
                          _subclasses: (
                              '&:hover': (
                                  text-decoration: none,
                              ),
                              '.title': (
                                  font-size: 2rem,
                              ),
                          ),
                      ),
                  ),
                  '.three' : (
                      _subclasses: (
                          '.post' : (
                              display: grid,
                              width: 100%,
                              grid-template-columns: 1fr,
                              grid-auto-rows: auto,
                              grid-gap: 0,
                              margin: 0 0 10px 0,
                              _responsive: (
                                  md: (
                                      grid-template-columns: auto 1fr,
                                      grid-gap: 1rem,
                                  ),
                              ),
                              _subclasses: (
                                  '.title': (
                                      display: block,
                                      margin: 0 0 10px 0,
                                  ),
                                  '.date' : (
                                      font-size: 0.825rem,
                                      color: #959595,
                                  )
                              )
                          )
                      )
                  ),
              ),
          ),
      )
  );

  @include mixins.generate-component(
          $hot-section,
          "hot",
          app.$config,
          app.$theme
  );

</style>
<style lang="scss">
  @use "sass:list";
  @use "sass:string";
  @use "sass:meta";
  @use "sass:map";

  @use "../styles/app.scss" as app;

  @use "../styles/scss/mixins.scss" as mixins;
  @use "../styles/scss/functions.scss" as functions;

  // --- art section --- //

  $art-section: (
      margin: 25px 0,
      _subclasses: (
          ".grid": (
              display: grid,
              width: 100%,
              grid-template-columns: 1fr 1fr,
              grid-auto-rows: auto,
              grid-gap: 1rem,
              _responsive: (
                  md: (
                      grid-template-columns: 1fr 1fr 1fr 1fr,
                      grid-gap: 1rem,
                  ),
              ),
              _subclasses: (
                  ".link": (
                      display: block,
                  ),
              ),
          ),
      ),
  );

  @include mixins.generate-component(
          $art-section,
          "art",
          app.$config,
          app.$theme
  );
</style>
